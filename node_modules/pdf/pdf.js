var sys = require('child_process');

exports.generate = function( url, outputFile, options, callback ) {
    if(typeof callback !== "function") {
        callback = null;
    }

    // Turn options into normalized and escaped arguments
    var optionsArray = [];

    Object.keys(options).forEach(function (paramObjectKey) {
        var paramObject = options[paramObjectKey];
        if (paramObjectKey !== 'global') {
            optionsArray.push(paramObjectKey);
        }
        Object.keys(paramObject).forEach(function (key) {
            // arguments should be escaped!!
            // look at old code and say what does it do?
            // var val = options[key].split(" ").join("");
            var val = paramObject[key];
            key = key.toLowerCase();

            optionsArray.push(key + ' ' + val);
        });
    });

    var optionsString = optionsArray.join(' ');

    var cmd = "/usr/local/bin/wkhtmltopdf " + optionsString + " " + url + " " + outputFile;
    console.log(cmd);
    
    sys.exec(cmd, function(err, stdout, stderr) {
        if(callback) {
            // err is not considered an error if the last line of stderr is "Done"
            if(err && !/\sDone\s*$/.test(stderr)) {
                callback(err, stderr);
            } else {
                callback(null, stdout);
            }
        }
    });
};
