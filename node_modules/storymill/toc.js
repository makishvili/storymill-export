var fs = require('fs');
var storymill = require("./storymill");
var textsCfg = require("./config").get('texts');

/**
 * Получить список текстов
 *
 * @param {Object} params
 * returns json
 */
exports.getTocList = function(params) {
    var dirs = fs.readdirSync(params.textsFolder);

    if (dirs.length === 0) {
        console.log('Опасность! Каталог с текстами пуст');
        return [];
    }

    var tocList = dirs.map(function(dirName){
        var dirPath = params.textsFolder + '/' + dirName;
        var filePath = dirPath +'/' + dirName + '.sm.html';

        var completed = textsCfg.completed.some(function(text){
            return text === dirName;
        });

        if (fs.existsSync(filePath)) {
            var storyJson = storymill.getStoryJson(filePath);

            return {
                name: dirName,
                title: storyJson[0].text,
                status: completed ? 'completed' : 'in progress'
            }
        }

        console.log('Ошибка: нет HTML-файла-сырца в директории' + dirPath);
        return false;
    });

    return tocList;
};
